\documentclass{article}
\title{Key parts of the code}
\begin{document}
\maketitle

The only input to \textt{var.apc.plot.fit} is \textt{apc.fit.indiv} so this is where we need to look to understand things.
The following items come into \texttt{var.apc.plot.fit} from earlier parts of the code (via \texttt{apc.fit.indiv})
\begin{itemize}
\item To control the choice of submodel, use \texttt{slopes} and \texttt{difdif}. Each is a three-length binary vector.
\item \texttt{xi.dim} indicates the number of APC matrix elements included.
\item \texttt{coefficients.canonical} is a matrix with a row for each included element of the APC matrix. There are four columns. The first is the estimated coefficient on that element, the second the standard error (square root of covariance), the third the t-statistic, and the fourth the p-value. The third and fourth are calculated from the first and second only. The coefficients come from \texttt{summary.glm(fit)\$coefficients} and the covariance from \texttt{summary.glm(fit)\$cov.scaled}. NOTE: \texttt{cov.scaled} is the standard covariance unless the dispersion is specified to differ from 1.
\item \texttt{index.age} identifies which elements of the matrix of coefficients are associated with age double differences. It uses \texttt{age.max}, which is the same as $I$ in the math. This also applies for period and cohort.
\item \texttt{dates} is a stacked vector of the labels for ages, periods, and cohorts. This uses \texttt{age1} and similar, which are the start points of the real values.
\item \texttt{per.odd} is true/false, and \texttt{U} is as defined in the math. \texttt{per.zero} is $L$
\end{itemize}

The following items are generated within \texttt{var.apc.plot.fit} by \texttt{apc.identify}
\begin{itemize}
\item Derived values \texttt{det.max}, \texttt{det.sub}, etc. are of unclear purpose. They are used in the creation of \texttt{index.age.max}, \texttt{index.age.sub}, etc. which seem to indicate which elements of a list are age double-differences, period double-differences, slopes, etc. \texttt{dates.max} etc. give the true dates associated with each, and they use \texttt{xi.max} etc. which were generated earlier and seem to be a dimensional vector. 
\item In each of the sets of derived values there are three types: \texttt{.max}, \texttt{.sub}, and \texttt{.dif}. It appears that \textt{.max} refers to the number of elements in the set of \{ the linear plane, the sums of double differences (ssdd) appropriate to each age, the ssdd appropriate to each period, and the ssdd appropriate to each cohort \}. The derived values without dots have the number of elements in the set \{ the linear plane, the double difference appropriate to each age, the DD appropriate to each period, and the DD appropriate to each cohort \}. Note that there are two fewer double-differences than sums-of-double-differences on each dimension (but in each dimension, two of the ssdds are equal to zero). \texttt{.sub} and \texttt{.dif} relate to the particular sub-model used.
\item \texttt{function.ssdd} is constructed, and applied to each of age, period, and cohort separetly. Once applied these are combined into \texttt{m.ssdd} which is then multiplied by \texttt{coefficients} to get \texttt{coefficients.ssdd} (and \texttt{names.ssdd} is then used to generate row names). The equivalent is done for \texttt{function.detrend}, \texttt{m.detrend}, etc.
\item \textt{function.ssdd} creates a matrix which provides for both forward and backward cumulation, as seen in equation 2.8 of my thesis. This is applied separately to each of A, P, and C to generate the matrix \textt{m.ssdd}. This matrix is multiplied by the estimates from the fit (which occurs prior to entering \textt{apc.identify}) of the linear plane and double-differences, found in the stored \textt{coefficients} matrix. The output is a matrix of estimates \textt{coefficients.ssdd}: the linear plane and \emph{sums} of double-differences at each age/period/cohort (thus the output is longer than the input, which lacks double-differences at two of each of ages/periods/cohorts). The function \textt{function.detrend} provides for the detrending of a series and its "anchoring" (i.e. points at which the value of the series is zero)  at the first elements of the series (rather than the middle). This is applied separately to each of A, P, and C to generate \textt{m.detrend}. This is multiplied by \textt{coefficients.ssdd} to get an output of \textt{coefficients.detrend} which has estimates of the \emph{new} linear plane (with trends reallocated to the plane) and the \emph{new} sums of double-differences at each age/period/cohort. For each dimension in both \textt{coefficients.detrend} and \textt{coefficients.ssdd} two of the sums of double-differences in each dimension are zero (the anchoring points).
\item To get the standard errors in \textt{coefficients.detrend} and \textt{coefficients.ssdd}, the covariance from the original fit is pre- and post-multiplied by the either \textt{m.detrend} or \textt{m.ssdd}, and the square root of the diagonal of the resulting matrix is taken. Some adjustments are made for "ad hoc identified" elements which have NA variance - these are the sums of double differences at the anchoring points, which are constrained to be zero.
\item There is also the \texttt{demean} and the \texttt{dif} representation. Both are constructed by applying a repetitive formulation to age, period, and cohort, and then combining them into \texttt{m.demean} and \texttt{m.dif}. We then construct \texttt{coefficients.demean} by multiplying \texttt{m.demean * coefficients.detrend}, and \texttt{coefficients.dif} from \texttt{m.dif} and \texttt{coefficients.detrend}. The covariances are constructed in the same way  
\end{itemize}

The following elements are interior to \texttt{var.apc.plot.fit}
\begin{itemize}
\item \texttt{v.do.plot} indicates which subplots are desired
\item \texttt{v.main.sub} gives titles to subplots
\item \texttt{l.dates} is a list of vectors indicating the horizontal axes for the subplots. \texttt{l.coefficients} is a list of vectors of the coefficients to be displayed in each subplot. For the first three plots,\texttt{coefficients.canonical} is used (though seems to be only one row?). \texttt{coefficients.sum.sum} is assigned to be either \texttt{coefficients.ssdd} or \texttt{coefficients.detrend} depending on earlier specification.
\item \texttt{v.xlab} gives the labels for the x-axes
\item All of the above are generated in a separate part of the code in the case that the type of plot requested is \texttt{dif} rather than \texttt{detrend} or \texttt{ssdd}. There are a few differences, the main substantive difference occurring in the definition of \texttt{l.coefficients}
\item There is an internal function \texttt{function.plot.est.sdv} which is used for each subplot. Sets dates on the x-axis, coefficient estimates on the y-axis. Important things to note: \texttt{scale} which if not zero means that the standard deviations will be scaled exponentially before lines are drawn. Option \texttt{sdv.at.zero} which determines whether the standard deviation lines are plotted around the estimate or not. Standard deviation is taken to be the second column of \texttt{coefficients}. \texttt{tau} determines whether the standard error lines are shown at all (they are not under mixed parameterisation)
\item As expected, it is \texttt{l.coefficients} that is used for the plotting
\end{itemize}

An account of the interior of \textt{apc.identify} can be found in the handwritten notes dated 30/08/16
\end{document}